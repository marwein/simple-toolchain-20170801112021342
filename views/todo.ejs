<!DOCTYPE html>

<html>
    <head>
        <title>Ma todolist</title>
        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

        <!-- Optional theme -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

        <style>
            a {text-decoration: none; color: black;}
            #todo-list {
                margin-top : 20px;
            }
            #todo-list .todo-item .btn-delete {
                cursor : pointer
            }
        </style>
    </head>

    <body>
    <div class="container">
        <h1>Ma todolist</h1>
        <div class="input-group" id="todo-form">
            <input type="text" class="form-control"name="newtodo" id="newtodo" placeholder="Que dois-je faire ?">
            <span class="input-group-btn">
                <button class="btn btn-default" type="button" id="submit">Ajouter</button>
            </span>
        </div>

        <ul id="todo-list" class="list-group"></ul>
    </div>

        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha256-k2WSCIexGzOj3Euiig+TlR8gA0EmPjuc79OEeY5L45g=" crossorigin="anonymous"></script>
        <!-- Latest compiled and minified JavaScript -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script>
            var socket = io.connect('<%= protocole %>://<%= host %>:<%= port %>/');
            
            socket.on('new-client', (lastTodo) => {
                if (lastTodo === null || lastTodo === undefined) {
                    $('#todo-list').append('<li id="empty" class="list-group-item">Empty</li>')
                } else {
                    $('#todo-list').append(`<li id="${lastTodo.id}" class="list-group-item"><button class="btn" onclick="deleteTodo('${lastTodo.id}')">✘</button> ${lastTodo.text}</li>`)    
                }
            });

            socket.on('new-added-todo', (todo) => {
                $('#todo-list #empty').remove()
                $('#todo-list').append(`<li id="${todo.id}" class="list-group-item"><button class="btn" onclick="deleteTodo('${todo.id}')">✘</button> ${todo.text}</li>`)
            });

            socket.on('deleted-todo', (id)=>{
                $(`#todo-list >li#${id}`).remove()
                if ($(`#todo-list >li`).length === 0) {
                    $('#todo-list').append('<li id="empty" class="list-group-item">Empty</li>')
                }
            })
            
            $('#todo-form #newtodo').on('keyup', (event) => {
                var keycode = event.keyCode || event.which
                if (keycode === 13){
                    createNewTodo(event.target.value)
                }
            });

            createNewTodo = (todo) => {
                var todo  = $('#newtodo').val()
                socket.emit('new-todo', todo)
                $('#newtodo').val('').focus()
            }

            $('#todo-form #submit').click( (e) => {
                var todo  = $('#newtodo').val()
                createNewTodo(todo)
            });

            deleteTodo = (id) => {
                socket.emit('delete-todo', id)
            }
        </script>
    </body>
</html>